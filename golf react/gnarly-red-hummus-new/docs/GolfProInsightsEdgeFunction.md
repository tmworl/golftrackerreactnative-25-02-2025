# Golf Pro Insights Edge Function

## Purpose
This Edge Function provides golf players personalized insights to improve their game by analyzing detailed round data. It leverages Claude's generative AI (Claude 3 Sonnet model) to generate actionable recommendations, pinpoint critical areas impacting scores, and suggest focused practice and management tips.

---

## Functionality

### Workflow
1. **API Key Validation:**
   - Fetches the Claude API key from environment variables (`CLAUDE_API_KEY`).
   - Ensures API key availability, returning an error if missing.

2. **Prompt Preparation:**
   - Defines a structured prompt explicitly asking Claude for insights:
     - `summary`
     - `primary_issue`
     - `reason`
     - `practice_focus`
     - `management_tip`
     - `progress` (optional)
   
   - Appends sample or provided golf data in JSON format to the prompt for Claude to analyze.

3. **Claude API Request:**
   - Sends an HTTP POST request to Claude's API endpoint with the formatted prompt.
   - Utilizes the `claude-3-7-sonnet-20250219` model with a 500-token limit for the response.

4. **Response Handling:**
   - Parses the response from Claude.
   - Attempts to convert Claude's response text into JSON.
   - Implements error handling if JSON parsing fails, returning raw response for frontend handling.

5. **Structured API Response:**
   - Returns insights generated by Claude in JSON format, including the original prompt and a timestamp.
   - Sets response headers to allow cross-origin access.

---

## Error Management
- Checks and logs errors at each step:
  - Missing API key
  - Claude API call failures
  - JSON parsing errors
- Provides clear and structured error messages, timestamped for debugging.

---

## Response Structure
Successful responses contain:

```json
{
  "message": "Golf insights generated successfully",
  "insights": {
    "summary": "...",
    "primary_issue": "...",
    "reason": "...",
    "practice_focus": "...",
    "management_tip": "...",
    "progress": "..." (optional)
  },
  "prompt_sent": "...",
  "timestamp": "ISO8601 timestamp"
}
```

In the event of parsing errors, responses fallback to:

```json
{
  "summary": "Error parsing insights",
  "raw_response": "Claude's raw text response"
}
```

---

## Frontend Integration Recommendations
- Handle insights display using structured JSON if parsing succeeds.
- Implement graceful fallbacks, displaying raw Markdown responses if parsing fails.
- Optionally use frontend Markdown rendering libraries for better user experience with non-JSON responses.

---

## Technologies Used
- **Runtime:** Deno
- **AI Model:** Claude 3 Sonnet (`claude-3-7-sonnet-20250219`)
- **Communication:** HTTP Requests via Fetch API

---

## Logging
- Logs detailed step-by-step information:
  - API key availability
  - Prompt content sent to Claude
  - Claude API response statuses and errors
  - JSON parsing results

